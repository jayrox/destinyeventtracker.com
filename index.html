<!doctype html>
<html>
	<head>
		<meta charset="utf-8">
		<title>Destiny Event Tracker</title>
		<link rel="stylesheet" href="style.css">
		<!-- remove me!!! -->
		<meta http-equiv="refresh" content="300">
	</head>
	<body>
	<div id="main" role="main">
	  <div id="header">
	  	Destiny Event Tracker
	  </div>
	  <div id="bar_container"></div>
	</div>
	<script src="//code.jquery.com/jquery-1.10.2.js"></script>
	<script src="/moment.js"></script>
	<script>
	  $.getJSON( "timers.json", function( data ) {
	  $.each( data, function( key, val ) {
	    var bars = [];
	    bar ='  <span class="bar_header">'+val.name+'</span>';
	    $.each( val.events, function( e_key, e_val ) {
	      // Build time offsets and duration for timer
	      d_offset = 0;
	      d_duration = 300;
	      if (e_val.type == 1) {
	      	d_offset = e_val.intervals[0].start;
	      	d_duration = e_val.intervals[0].end - e_val.intervals[0].start;
	      }
	      
	      // Create description
	      bar_description = "";
	      $.each( e_val.subEvents, function( se_key, se_val ) {
		bar_description += se_val + ", ";	      	
	      });
	      
	      // FIXME: Placeholder
	      timer = "in 10 mins";
	      
	      // Build bar item
	      bar_description = bar_description.substring(0, bar_description.length - 2);
	      bar +='  <div class="bar" data-offset="'+d_offset+'" data-duration="'+d_duration+'">';
 	      bar +='    <span class="bar_location">'+e_val.name+'</span>';
	      bar +='    <span class="bar_description">'+bar_description+'</span>';
	      bar +='    <span class="bar_timer">'+timer+'</span>';
	      bar +='  </div>';
	    });
	    bar +='</div>';
	    bars.push( bar );
	    $( "<div/>", {
	      class: 'bar_group',
	      id: val.name,
	      html: bars.join( "" )
	    }).appendTo( "#bar_container" );
	  });
	});
	
	$(function() {
	    function updateAllEvents() {
	        $('.bar').each(function() {
	            var box = $(this);
	            var countDown = box.find('.bar_timer');
	            var eventOffsetData = parseInt(box.data('offset'));
	            //var eventRepeatData = parseInt(box.data('repeat'));
	            var eventDurationData = parseInt(box.data('duration'));
	            var eventHappening = false;
	            
	            console.log("bar: "+eventOffsetData+" "+eventDurationData);
	
	            // eventStart represents the closest start time
	            // get the start of the current hour
	            // add when the event starts
	            var eventStart = moment().startOf('hour').add(eventOffsetData, 'm');
	            var eventComplete = moment(eventStart);
	            eventComplete.add(eventDurationData, 'm');
	            
	            //while(eventComplete < moment()) {
	            //    eventStart.add(eventRepeatData, 'm');
	            //    eventComplete.add(eventRepeatData, 'm');
	            //}
	            
	            var percent = Math.round((((60 - eventStart.diff(moment(), 'minutes')) / 60) * 100));
	            
	            console.log(eventStart.format('h:mm'));
	            console.log(eventComplete.format('h:mm'));
	            console.log('-----');
	            
	            if((eventStart < moment()) && (moment() < eventComplete)) {
	                eventHappening = true;
	            } else {
	                eventHappening = false;
	            }
	            
	            if (eventHappening) {
	                countDown.html( "In progress" );
	                percent = 100;
	                //box remove dark, use red 
	            } else {
	                countDown.html( eventStart.fromNow() );
	            }
	            
	            //progressBar.width(percent + "%");
	            //$(this).data('percent', percent);
	        });
	        
	        /*
	        // Sort earth
	        $('.info-box.earth').sort(function(a, b){
	            var percentA = parseInt($(a).data('percent'));
	            var percentB = parseInt($(b).data('percent'));
	            return percentB - percentA;
	        }).appendTo(".earthWrapper");
	        
	        // Sort moon
	        $('.info-box.moon').sort(function(a, b){
	            var percentA = parseInt($(a).data('percent'));
	            var percentB = parseInt($(b).data('percent'));
	            return percentB - percentA;
	        }).appendTo(".moonWrapper");
	        
	        // Sort venus
	        $('.info-box.venus').sort(function(a, b){
	            var percentA = parseInt($(a).data('percent'));
	            var percentB = parseInt($(b).data('percent'));
	            return percentB - percentA;
	        }).appendTo(".venusWrapper");
	        
	        // Sort mars
	        $('.info-box.mars').sort(function(a, b){
	            var percentA = parseInt($(a).data('percent'));
	            var percentB = parseInt($(b).data('percent'));
	            return percentB - percentA;
	        }).appendTo(".marsWrapper");
	        */
	    }
	
	    updateAllEvents();    
	    setInterval(updateAllEvents, 30 * 1000);
	});
	
	$(document).on("click", 'div.bar, div.bar > span', function(e) {
		$('.bar_description', this).toggleClass("show");
	});
	
	$(document).on("click", 'span.bar_header', function(e) {
		$(this).siblings('div.bar').toggleClass("hide");
	});
	</script>
	</body>
</html>
