<!doctype html>
<html>
	<head>
		<meta charset="utf-8">
		<title>Destiny Event Tracker</title>
		<link rel="stylesheet" href="style.css">
		<!-- remove me!!! -->
		<meta http-equiv="refresh" content="300">
	</head>
	<body>
	<div id="main" role="main">
	  <div id="header">
	  	Destiny Event Tracker
	  </div>
	  <div id="bar_container"></div>
	</div>
	<script src="//code.jquery.com/jquery-1.10.2.js"></script>
	<script src="/moment.js"></script>
	<script>
	  $.getJSON( "timers.json", function( data ) {
	  $.each( data, function( key, val ) {
	    var bars = [];
	    var planetname = val.name;
	    var lplanetname = planetname.toLowerCase();
	    bar ='  <span class="bar_header">'+planetname+'</span>';
	    bar+='  <div id="'+lplanetname+'wrapper">";
	    $.each( val.events, function( e_key, e_val ) {
	      // Build time offsets and duration for timer
	      d_offset = d_offset2 = 0;
	      d_duration = d_duration2 = 0;
	      if (e_val.type == 1) {
	      	d_offset = e_val.intervals[0].start;
	      	d_duration = e_val.intervals[0].end - d_offset;
	      	if (typeof e_val.intervals[1] != 'undefined') {
		  d_offset2 = e_val.intervals[1].start;
		  d_duration2 = e_val.intervals[1].end - d_offset2;
		}
	      }
	      
	      // Create description
	      bar_description = "";
	      $.each( e_val.subEvents, function( se_key, se_val ) {
		bar_description += se_val + ", ";	      	
	      });
	      
	      // Build bar item
	      bar_description = bar_description.substring(0, bar_description.length - 2);
	      bar +='  <div class="bar" data-offset="'+d_offset+'" data-duration="'+d_duration+'" data-offset2="'+d_offset2+'" data-duration2="'+d_duration2+'" data-percent="">';
 	      bar +='    <span class="bar_location">'+e_val.name+'</span>';
	      bar +='    <span class="bar_description">'+bar_description+'</span>';
	      bar +='    <span class="bar_timer">&nbsp;</span>';
	      bar +='  </div>';
	    });
	    bar +='</div></div>';
	    bars.push( bar );
	    $( "<div/>", {
	      class: 'bar_group',
	      id: val.name,
	      html: bars.join( "" )
	    }).appendTo( "#bar_container" );
	  });
	});
	
	$(function() {
	    function updateAllEvents() {
	        $('.bar').each(function() {
	            var box = $(this);
	            var countDown = box.find('.bar_timer');
	            var eventOffsetData = parseInt(box.data('offset'));
	            var eventDurationData = parseInt(box.data('duration'));
	            var eventOffset2Data = parseInt(box.data('offset2'));
	            var eventRepeatData = 3600;
	            if (eventOffset2Data > eventOffsetData) {
	            	eventRepeatData = eventOffset2Data - eventOffsetData;
	            }
	            var eventDuration2Data = parseInt(box.data('duration2'));
	            var eventHappening = false;
	            
		    if (eventOffsetData == 0 && eventDurationData == 0) {
		    	console.log("continue");
		    	return;
		    }
	            // eventStart represents the closest start time
	            // get the start of the current hour
	            // add when the event starts
	            var eventStart = moment().startOf('hour').add(eventOffsetData, 's');
	            var eventComplete = moment(eventStart);
	            eventComplete.add(eventDurationData, 's');
	            
	            while(eventComplete < moment()) {
	                eventStart.add(eventRepeatData, 's');
	                eventComplete.add(eventRepeatData, 's');
	            }
	            
	            var percent = Math.round((((60 - eventStart.diff(moment(), 'minutes')) / 60) * 100));
	            console.log("percent: "+percent);
	            
	            console.log(eventStart.format('h:mm'));
	            console.log(eventComplete.format('h:mm'));
	            console.log('-----');
	            
	            if((eventStart < moment()) && (moment() < eventComplete)) {
	                eventHappening = true;
	            } else {
	                eventHappening = false;
	            }
	            
	            if (eventHappening) {
	                countDown.html( "In progress" );
	                percent = 100;
	                //box remove dark, use red 
	            } else {
	                countDown.html( eventStart.fromNow() );
	            }
	            
	            $(this).data('percent', percent);
	            $(box).css('background', '#4186fc');
  		    $(box).css('background', '-moz-linear-gradient(left,  #4186fc 0%, #4186fc '+percent+'%, #3a3a3a '+(percent+1)+'%, #3a3a3a 100%');
  		    $(box).css('background', '-webkit-gradient(linear, left top, right top, color-stop(0%,#4186fc), color-stop('+percent+'%,#4186fc), color-stop('+(percent+1)+'%,#3a3a3a), color-stop(100%,#3a3a3a)');
  		    $(box).css('background', '-webkit-linear-gradient(left,  #4186fc 0%,#4186fc '+percent+'%,#3a3a3a '+(percent+1)+'%,#3a3a3a 100%');
  		    $(box).css('background', '-o-linear-gradient(left,  #4186fc 0%,#4186fc '+percent+'%,#3a3a3a '+(percent+1)+'%,#3a3a3a 100%');
  		    $(box).css('background', '-ms-linear-gradient(left,  #4186fc 0%,#4186fc '+percent+'%,#3a3a3a '+(percent+1)+'%,#3a3a3a 100%');
  		    $(box).css('background', 'linear-gradient(to right,  #4186fc 0%,#4186fc '+percent+'%,#3a3a3a '+(percent+1)+'%,#3a3a3a 100%');
  		    $(box).css('background', 'progid:DXImageTransform.Microsoft.gradient( startColorstr=\'#4186fc\', endColorstr=\'#3a3a3a\',GradientType=1');
	        });
	        
	        /*
	        // Sort earth
	        $('.info-box.earth').sort(function(a, b){
	            var percentA = parseInt($(a).data('percent'));
	            var percentB = parseInt($(b).data('percent'));
	            return percentB - percentA;
	        }).appendTo(".earthWrapper");
	        
	        // Sort moon
	        $('.info-box.moon').sort(function(a, b){
	            var percentA = parseInt($(a).data('percent'));
	            var percentB = parseInt($(b).data('percent'));
	            return percentB - percentA;
	        }).appendTo(".moonWrapper");
	        
	        // Sort venus
	        $('.info-box.venus').sort(function(a, b){
	            var percentA = parseInt($(a).data('percent'));
	            var percentB = parseInt($(b).data('percent'));
	            return percentB - percentA;
	        }).appendTo(".venusWrapper");
	        
	        // Sort mars
	        $('.info-box.mars').sort(function(a, b){
	            var percentA = parseInt($(a).data('percent'));
	            var percentB = parseInt($(b).data('percent'));
	            return percentB - percentA;
	        }).appendTo(".marsWrapper");
	        */
	    }
	
	    updateAllEvents();    
	    setInterval(updateAllEvents, 30 * 1000);
	});
	
	$(document).on("click", 'div.bar, div.bar > span', function(e) {
		$('.bar_description', this).toggleClass("show");
	});
	
	$(document).on("click", 'span.bar_header', function(e) {
		$(this).siblings('div.bar').toggleClass("hide");
	});
	</script>
	</body>
</html>
